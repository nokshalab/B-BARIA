<!DOCTYPE html>
<html lang="bn" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noksha Lab Tracker</title>
    
    <!-- Tailwind Setup -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f8fafc',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2382/2382461.png">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .hidden-content { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 60; backdrop-filter: blur(3px); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .animate-bounce-in { animation: bounceIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* Scrollbar Styles */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Loader Utility */
        .hidden-loader { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen py-6 px-3 pb-20 relative bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100">

    <!-- Main Loader -->
    <div id="loader" class="loading-overlay bg-white/90 dark:bg-slate-900/90">
        <i data-lucide="loader-2" class="w-10 h-10 text-emerald-600 animate-spin mb-3"></i>
        <p class="text-slate-600 dark:text-slate-300 font-bold" id="loaderText">লোডিং...</p>
    </div>

    <!-- 1. LOGIN SCREEN -->
    <div id="loginScreen" class="auth-screen bg-slate-800 dark:bg-slate-950">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-xs text-center border border-transparent dark:border-slate-700">
            <div class="bg-emerald-100 dark:bg-emerald-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8 text-emerald-600 dark:text-emerald-400"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">নিরাপত্তা চেক</h2>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">নকশা ল্যাব এর তথ্য দেখতে পিন দিন</p>
            
            <input type="password" id="pinInput" placeholder="PIN" class="w-full text-center text-2xl font-bold tracking-widest border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg py-3 mb-4 focus:border-emerald-500 outline-none">
            
            <div id="nameInputArea" class="hidden-content mb-4 text-left">
                <label class="text-xs text-slate-500 dark:text-slate-400 font-bold block mb-1">আপনার নাম (একবার):</label>
                <input type="text" id="userNameInput" placeholder="যেমন: মিজান" class="w-full text-sm border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg py-2 px-3 focus:border-emerald-500 outline-none">
            </div>

            <button onclick="checkPin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition shadow-lg">লগইন করুন</button>
            <p id="errorMsg" class="text-red-500 text-xs mt-3 hidden">ভুল পিন!</p>
        </div>
    </div>

    <!-- 2. CONFIRMATION MODAL -->
    <div id="confirmModal" class="modal">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md mx-4 shadow-2xl border border-slate-200 dark:border-slate-700 animate-bounce-in overflow-hidden">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 text-white">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="check-circle-2" class="w-6 h-6"></i> নিশ্চিত করুন</h3>
                <p class="text-xs text-emerald-100 mt-0.5">ডাটাবেসে সেভ করার আগে হিসাব মিলিয়ে নিন</p>
            </div>
            
            <div class="p-5 space-y-4">
                <div class="bg-slate-50 dark:bg-slate-700/30 p-3 rounded-lg border border-slate-100 dark:border-slate-600 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-slate-500 dark:text-slate-400">কাজের নাম</p>
                        <p class="font-bold text-slate-800 dark:text-white" id="confNote">...</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-500 dark:text-slate-400">মোট টাকা</p>
                        <p class="font-bold text-xl text-emerald-600 dark:text-emerald-400" id="confAmount">৳0</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-100 dark:border-blue-800/30">
                        <h4 class="text-xs font-bold text-blue-600 dark:text-blue-400 mb-2 uppercase">আপনার হিসাব</h4>
                        <div class="space-y-2">
                            <div>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400">বর্তমান পাওনা</p>
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-slate-400 line-through" id="confUserOld">0</span>
                                    <i data-lucide="arrow-right" class="w-3 h-3 text-blue-400"></i>
                                    <span class="font-bold text-blue-700 dark:text-blue-300" id="confUserNew">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 bg-orange-50 dark:bg-orange-900/10 rounded-lg border border-orange-100 dark:border-orange-800/30">
                        <h4 class="text-xs font-bold text-orange-600 dark:text-orange-400 mb-2 uppercase">মালিকের হিসাব</h4>
                        <div class="space-y-2">
                            <div>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400">মোট পাবে</p>
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-slate-400 line-through" id="confShopOld">0</span>
                                    <i data-lucide="arrow-right" class="w-3 h-3 text-orange-400"></i>
                                    <span class="font-bold text-orange-700 dark:text-orange-300" id="confShopNew">0</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400">এই কাজে খরচ</p>
                                <span class="font-bold text-red-500 text-xs" id="confThisCost">৳0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 dark:bg-slate-800 border-t dark:border-slate-700 flex gap-3">
                <button onclick="document.getElementById('confirmModal').style.display='none'" class="flex-1 py-3 border border-slate-300 dark:border-slate-600 rounded-xl text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-100 dark:hover:bg-slate-700 transition">এডিট করুন</button>
                <button onclick="executeFinalSave()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 shadow-lg transition flex justify-center items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> নিশ্চিত সেভ
                </button>
            </div>
        </div>
    </div>

    <!-- 3. COST MODAL -->
    <div id="costModal" class="modal">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl max-w-sm mx-4 w-full text-center animate-bounce-in border border-slate-200 dark:border-slate-700">
            <div class="mx-auto bg-blue-100 dark:bg-blue-900/30 w-14 h-14 rounded-full flex items-center justify-center mb-4 border-4 border-blue-50 dark:border-blue-900/20">
                <i data-lucide="tag" class="w-7 h-7 text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1">নতুন কাজ শনাক্ত হয়েছে!</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">"<span id="newServiceName" class="font-bold text-blue-600 dark:text-blue-400"></span>" এর জন্য মালিকের খরচ কত টাকা?</p>
            <input type="number" id="costInput" placeholder="খরচ (টাকা)" class="w-full border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg py-2 px-4 mb-4 focus:border-blue-500 outline-none text-center font-bold text-lg">
            <div class="flex gap-3">
                <button onclick="cancelCost()" class="flex-1 py-2.5 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition">বাতিল</button>
                <button onclick="confirmCost()" class="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg transition">পরবর্তী ধাপ</button>
            </div>
        </div>
    </div>

    <!-- 4. TRASH MODAL -->
    <div id="trashModal" class="modal">
        <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-md mx-4 h-[80vh] flex flex-col shadow-2xl border border-slate-200 dark:border-slate-700 animate-bounce-in">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-red-50 dark:bg-red-900/20 rounded-t-xl">
                <h3 class="font-bold text-red-600 dark:text-red-400 flex items-center gap-2"><i data-lucide="trash-2" class="w-5 h-5"></i> রিসাইকেল বিন</h3>
                <button onclick="document.getElementById('trashModal').style.display='none'" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 text-[10px] text-center text-yellow-700 dark:text-yellow-400 border-b border-yellow-100 dark:border-yellow-900/30">
                এখান থেকে রিস্টোর বা চিরতরে ডিলিট করা যাবে।
            </div>
            <div id="trashList" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <!-- 5. HISTORY MODAL -->
    <div id="historyModal" class="modal">
        <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-md mx-4 h-[80vh] flex flex-col shadow-2xl border border-slate-200 dark:border-slate-700 animate-bounce-in">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 rounded-t-xl">
                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="history" class="w-5 h-5"></i> অ্যাক্টিভিটি লগ</h3>
                <button onclick="document.getElementById('historyModal').style.display='none'" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="logList" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <!-- 6. SERVICE LIST MODAL -->
    <div id="serviceListModal" class="modal">
        <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-sm mx-4 h-[70vh] flex flex-col shadow-2xl animate-bounce-in border border-slate-200 dark:border-slate-700">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 rounded-t-xl">
                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="list" class="w-5 h-5"></i> কাজের তালিকা</h3>
                <button onclick="document.getElementById('serviceListModal').style.display='none'" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="serviceListContainer" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        </div>
    </div>

    <!-- 7. SETTINGS MODAL -->
    <div id="settingsModal" class="modal">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-5 w-full max-w-md mx-4 shadow-2xl border border-slate-200 dark:border-slate-700 relative max-h-[90vh] overflow-y-auto animate-bounce-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">সেটিংস</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="mb-6">
                <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">থিম (Theme)</h4>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setTheme('light')" class="p-2 border dark:border-slate-600 rounded flex flex-col items-center gap-1 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="sun" class="w-5 h-5 text-orange-500"></i> <span class="text-xs dark:text-slate-300">লাইট</span>
                    </button>
                    <button onclick="setTheme('dark')" class="p-2 border dark:border-slate-600 rounded flex flex-col items-center gap-1 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="moon" class="w-5 h-5 text-slate-600 dark:text-slate-300"></i> <span class="text-xs dark:text-slate-300">ডার্ক</span>
                    </button>
                    <button onclick="setTheme('system')" class="p-2 border dark:border-slate-600 rounded flex flex-col items-center gap-1 hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i data-lucide="monitor" class="w-5 h-5 text-blue-500"></i> <span class="text-xs dark:text-slate-300">সিস্টেম</span>
                    </button>
                </div>
            </div>

            <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">ডাটাবেস কনফিগারেশন</h4>
            <textarea id="configInput" rows="4" class="w-full border dark:border-slate-600 p-3 rounded-lg text-xs font-mono bg-slate-50 dark:bg-slate-900 dark:text-slate-300 mb-3 focus:border-emerald-500 outline-none" placeholder='ফায়ারবেস কোড...'></textarea>
            <button onclick="saveConfig()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-sm mb-6">সেভ কনফিগারেশন</button>

            <div class="border-t-2 border-red-100 dark:border-red-900/30 pt-4 mt-2">
                <h4 class="text-red-600 dark:text-red-400 font-bold text-sm flex items-center gap-2 mb-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> ডেঞ্জার জোন</h4>
                <button onclick="initiateFactoryReset()" class="w-full border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 hover:bg-red-600 hover:text-white py-2 rounded-lg font-bold text-xs transition">সিস্টেম রিসেট (সব মুছুন)</button>
            </div>
        </div>
    </div>

    <!-- 8. MAIN APP UI -->
    <div id="mainApp" class="hidden-content max-w-lg mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-200 dark:border-slate-700">
        <!-- Header -->
        <div class="bg-slate-800 dark:bg-slate-900 p-4 text-white flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="calculator" class="w-5 h-5 text-emerald-400"></i>
                <div>
                    <span class="font-bold text-lg block leading-none">নকশা ল্যাব</span>
                    <span class="text-[10px] text-slate-400" id="welcomeUser"></span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openTrash()" class="bg-slate-700 dark:bg-slate-800 p-2 rounded-full hover:bg-red-900 text-red-300 border border-transparent hover:border-red-500/50 transition" title="ট্র্যাশ">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
                <button onclick="openHistory()" class="bg-slate-700 dark:bg-slate-800 p-2 rounded-full hover:bg-slate-600 text-slate-300" title="হিস্ট্রি">
                    <i data-lucide="history" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center gap-1 text-xs bg-emerald-500/20 px-2 py-1 rounded-full text-emerald-300 border border-emerald-500/30">
                    <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                </div>
                <button onclick="openSettings()" class="p-1 hover:bg-slate-700 rounded-full text-slate-300"><i data-lucide="settings" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Stats -->
        <div class="px-4 mt-4 mb-4 space-y-4">
            <!-- User Card -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10"><i data-lucide="wallet" class="w-24 h-24"></i></div>
                <div class="relative z-10">
                    <p class="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">বর্তমান পাওনা (আপনার)</p>
                    <h2 class="text-4xl font-bold" id="currentDueDisplay">৳ 0</h2>
                    <div class="mt-4 flex gap-4 text-xs text-blue-100 border-t border-blue-500/30 pt-3">
                        <div><span class="opacity-70 block">মোট আয়</span><span id="totalEarnedDisplay" class="font-bold">৳ 0</span></div>
                        <div class="w-px bg-blue-500/50"></div>
                        <div><span class="opacity-70 block">তোলা হয়েছে</span><span id="totalWithdrawnDisplay" class="font-bold">৳ 0</span></div>
                    </div>
                </div>
            </div>

            <!-- Owner Card -->
            <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-4 border border-orange-100 dark:border-orange-900/30 relative overflow-hidden">
                 <div class="absolute right-0 top-0 p-2 opacity-5"><i data-lucide="store" class="w-24 h-24 text-orange-600 dark:text-orange-400"></i></div>
                 <div class="relative z-10">
                     <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-orange-600 dark:text-orange-400 text-xs font-bold uppercase tracking-wider">দোকান মালিক পাবে</p>
                            <h2 class="text-3xl font-bold text-orange-700 dark:text-orange-300" id="shopShareDisplay">৳ 0</h2>
                        </div>
                        <div class="p-2 bg-orange-100 dark:bg-orange-900/40 rounded-full">
                            <i data-lucide="store" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
                        </div>
                     </div>
                     <div class="flex gap-4 text-xs border-t border-orange-200 dark:border-orange-800/50 pt-3">
                        <div><span class="block text-orange-500 dark:text-orange-400/70">খরচ ফেরত</span><span class="font-bold text-orange-700 dark:text-orange-300 text-sm" id="shopRecoveredDisplay">৳ 0</span></div>
                        <div class="w-px bg-orange-200 dark:bg-orange-800/50"></div>
                        <div><span class="block text-orange-500 dark:text-orange-400/70">নিট লাভ</span><span class="font-bold text-orange-700 dark:text-orange-300 text-sm" id="shopProfitDisplay">৳ 0</span></div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Input -->
        <div class="px-4 pb-4">
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg mb-4">
                    <button onclick="setType('income')" id="btnIncome" class="flex-1 py-2 text-sm font-bold rounded-md flex items-center justify-center gap-2 bg-white dark:bg-slate-600 text-emerald-600 dark:text-emerald-400 shadow-sm"><i data-lucide="arrow-up-right" class="w-4 h-4"></i> নতুন কাজ</button>
                    <button onclick="setType('withdrawal')" id="btnWithdraw" class="flex-1 py-2 text-sm font-bold rounded-md flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400"><i data-lucide="arrow-down-left" class="w-4 h-4"></i> টাকা গ্রহণ</button>
                </div>
                <form id="transactionForm" class="space-y-3">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">৳</span>
                        <input type="number" id="amountInput" placeholder="টাকার পরিমাণ" class="w-full pl-8 pr-4 py-3 rounded-lg border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-emerald-500 outline-none text-xl font-bold" required>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="text" id="noteInput" list="serviceSuggestions" placeholder="কাজের নাম" class="flex-1 px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-emerald-500 outline-none" required>
                        <button type="button" onclick="openServiceList()" class="bg-slate-100 dark:bg-slate-700 px-4 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                            <i data-lucide="list" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <datalist id="serviceSuggestions"></datalist>

                    <button type="submit" id="submitBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> সেভ করুন</button>
                </form>
            </div>
        </div>

        <!-- List -->
        <div class="border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
            <div class="px-6 py-3 bg-slate-50 dark:bg-slate-900/50 text-xs font-bold text-slate-400 uppercase tracking-wider flex justify-between items-center">
                <span>লেনদেনের ইতিহাস</span>
            </div>
            <div id="transactionList" class="overflow-y-auto max-h-[400px] divide-y divide-slate-100 dark:divide-slate-700"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, setDoc, onSnapshot, query, doc, deleteDoc, getDoc, getDocs, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // SETTINGS
        window.MY_SECRET_PIN = "8267"; 
        const firebaseConfig = {
            apiKey: "AIzaSyDY0pU6WWTd-QWfe-dF-RtFwR5fGMZqNy4",
            authDomain: "noksha-lab.firebaseapp.com",
            projectId: "noksha-lab",
            storageBucket: "noksha-lab.firebasestorage.app",
            messagingSenderId: "47480782384",
            appId: "1:47480782384:web:5523d7e200c950ca7c37f5"
        }; 

        const appId = 'noksha-lab-default';
        let db, auth, currentUser, currentType = 'income', transactions = [], services = [], serviceMap = {};
        let sessionUser = localStorage.getItem('noksha_username') || "";
        let pendingTransaction = null;
        let currentStats = {}; // To hold stats for modal

        // THEME & INIT
        function applyTheme(theme) {
            if(theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('noksha_theme', theme);
        }
        window.setTheme = applyTheme;
        applyTheme(localStorage.getItem('noksha_theme') || 'system');
        if(!sessionUser) document.getElementById('nameInputArea').classList.remove('hidden-content');

        window.checkPin = function() {
            const input = document.getElementById('pinInput').value;
            const nameInput = document.getElementById('userNameInput').value.trim();
            if(input === window.MY_SECRET_PIN) {
                if(!sessionUser && !nameInput) { alert("নাম আবশ্যক!"); return; }
                if(nameInput) { sessionUser = nameInput; localStorage.setItem('noksha_username', sessionUser); }
                document.getElementById('loginScreen').classList.add('hidden-content');
                document.getElementById('mainApp').classList.remove('hidden-content');
                document.getElementById('welcomeUser').innerText = sessionUser;
                initFirebase(); 
            } else { document.getElementById('errorMsg').classList.remove('hidden'); }
        }

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                currentUser = auth.currentUser;
                
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_transactions_live'));
                onSnapshot(q, (snapshot) => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    transactions.sort((a, b) => b.timestamp - a.timestamp);
                    render();
                    document.getElementById('loader').classList.add('hidden-loader');
                });

                const sQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_services'));
                onSnapshot(sQ, (snapshot) => {
                    services = []; serviceMap = {};
                    const datalist = document.getElementById('serviceSuggestions');
                    datalist.innerHTML = '';
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        services.push({ id: doc.id, ...data });
                        serviceMap[data.name.toLowerCase()] = data.cost;
                        const option = document.createElement('option');
                        option.value = data.name;
                        datalist.appendChild(option);
                    });
                    services.sort((a, b) => a.name.localeCompare(b.name));
                    if(document.getElementById('serviceListModal').style.display === 'flex') renderServiceList();
                });
            } catch (e) { 
                alert("কানেকশন এরর!"); 
                document.getElementById('loader').classList.add('hidden-loader');
            }
        }

        // --- MAIN LOGIC WITH CONFIRMATION ---
        window.saveTransaction = async function(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('amountInput').value);
            const note = document.getElementById('noteInput').value.trim();
            if (!amount || !note) return;

            // Store initial data
            pendingTransaction = { amount, note, type: currentType };

            if(currentType === 'income') {
                const cost = serviceMap[note.toLowerCase()];
                if (cost !== undefined) { 
                    prepareConfirmation(cost);
                } else {
                    document.getElementById('newServiceName').innerText = note;
                    document.getElementById('costInput').value = '';
                    document.getElementById('costModal').style.display = 'flex';
                }
            } else {
                // Withdrawal - no cost, simpler confirm
                prepareConfirmation(0);
            }
        };

        window.confirmCost = async () => {
            const cost = parseFloat(document.getElementById('costInput').value);
            if(isNaN(cost)) { alert("সংখ্যা লিখুন"); return; }
            
            // Save new service silently first
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_services'), {
                    name: pendingTransaction.note, cost: cost, addedBy: sessionUser
                });
                document.getElementById('costModal').style.display = 'none';
                prepareConfirmation(cost);
            } catch(e) { alert("এরর!"); }
        }
        window.cancelCost = () => { document.getElementById('costModal').style.display = 'none'; pendingTransaction = null; }

        // Show Confirmation Modal
        function prepareConfirmation(cost) {
            const amount = pendingTransaction.amount;
            pendingTransaction.cost = cost;

            // Calculate hypothetical totals based on currentStats
            let netProfit = 0, userShare = 0, shopShare = 0;
            
            if(pendingTransaction.type === 'income') {
                netProfit = amount - cost;
                userShare = netProfit / 2;
                shopShare = cost + (netProfit / 2);
            } else {
                // Withdrawal
                userShare = -amount; // Reduces user due
                // Shop doesn't get anything, just recording user took money
            }

            const newDue = currentStats.userDue + userShare;
            const newShopTotal = currentStats.shopTotal + shopShare;

            // Update UI
            document.getElementById('confNote').innerText = pendingTransaction.note;
            document.getElementById('confAmount').innerText = `৳${amount.toLocaleString()}`;
            
            document.getElementById('confUserOld').innerText = `৳${currentStats.userDue.toLocaleString()}`;
            document.getElementById('confUserNew').innerText = `৳${newDue.toLocaleString()}`;
            
            document.getElementById('confShopOld').innerText = `৳${currentStats.shopTotal.toLocaleString()}`;
            document.getElementById('confShopNew').innerText = `৳${newShopTotal.toLocaleString()}`;
            document.getElementById('confThisCost').innerText = `৳${cost.toLocaleString()}`;

            document.getElementById('confirmModal').style.display = 'flex';
        }

        window.executeFinalSave = async function() {
            document.getElementById('confirmModal').style.display = 'none';
            const { amount, note, cost, type } = pendingTransaction;
            const now = new Date();
            
            const newTx = {
                amount: amount, cost: cost, note: note, type: type,
                date: now.toLocaleDateString('bn-BD'), time: now.toLocaleTimeString('bn-BD'),
                timestamp: Date.now(), createdBy: currentUser.uid, authorName: sessionUser
            };

            if (type === 'income') { 
                const netProfit = amount - cost;
                newTx.userShare = netProfit / 2; 
                newTx.shopShare = cost + (netProfit / 2);
            }

            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_transactions_live'), newTx);
                logAction(type === 'income' ? 'ADD_INCOME' : 'ADD_WITHDRAW', `${amount} টাকা (${note})`);
                document.getElementById('amountInput').value = ''; document.getElementById('noteInput').value = ''; 
                pendingTransaction = null;
            } catch(e) { alert("সেভ হয়নি!"); }
        }

        // --- RENDER & CALCS ---
        function render() {
            let totalProfit = 0, userEarned = 0, shopEarned = 0, userWithdrawn = 0;
            let totalRecoveredCost = 0, totalOwnerProfit = 0;

            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            
            transactions.forEach(t => {
                const isIncome = (t.type || 'income') === 'income';
                if (isIncome) {
                    const cost = t.cost || 0;
                    const netProfit = t.amount - cost;
                    totalRecoveredCost += cost;
                    const ownerProfitShare = netProfit / 2;
                    totalOwnerProfit += ownerProfitShare;
                    totalProfit += netProfit;
                    userEarned += (netProfit / 2);
                    shopEarned += (cost + ownerProfitShare);
                } else { userWithdrawn += t.amount; }
                
                const author = t.authorName ? `<span class="text-[10px] text-slate-400 ml-1">• ${t.authorName}</span>` : '';
                const costBadge = (isIncome && t.cost > 0) ? `<span class="text-[9px] bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300 px-1 rounded border border-blue-200 dark:border-blue-800">খরচ: ৳${t.cost}</span>` : '';
                
                list.innerHTML += `<div class="p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-4 ${isIncome ? 'border-emerald-400' : 'border-red-400 bg-red-50/30'} group flex justify-between"><div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200 flex items-center gap-2">${t.note} ${!isIncome ? '<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded">আদায়</span>' : ''} ${costBadge}</h4><div class="flex gap-2 text-[10px] text-slate-400 mt-1 items-center"><i data-lucide="calendar" class="w-3 h-3"></i> ${t.date}, ${t.time} ${author}</div></div><div class="text-right"><span class="block font-bold text-lg ${isIncome ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400'}">${isIncome ? '+' : '-'} ৳ ${t.amount}</span><button onclick="deleteItem('${t.id}')" class="text-red-300 hover:text-red-500 dark:hover:text-red-400 text-xs opacity-0 group-hover:opacity-100">মুছুন</button></div></div>`;
            });

            // Update Stats State for Modal
            currentStats = {
                userDue: userEarned - userWithdrawn,
                userEarned: userEarned,
                shopTotal: shopEarned,
                shopCost: totalRecoveredCost,
                shopProfit: totalOwnerProfit
            };

            document.getElementById('currentDueDisplay').innerText = `৳ ${(userEarned - userWithdrawn).toLocaleString()}`;
            document.getElementById('totalEarnedDisplay').innerText = `৳ ${userEarned.toLocaleString()}`;
            document.getElementById('totalWithdrawnDisplay').innerText = `৳ ${userWithdrawn.toLocaleString()}`;
            document.getElementById('shopShareDisplay').innerText = `৳ ${shopEarned.toLocaleString()}`;
            document.getElementById('shopRecoveredDisplay').innerText = `৳ ${totalRecoveredCost.toLocaleString()}`;
            document.getElementById('shopProfitDisplay').innerText = `৳ ${totalOwnerProfit.toLocaleString()}`;
            lucide.createIcons();
        }

        // --- OTHER FUNCTIONS (Trash, Service List, Settings etc.) ---
        async function logAction(actionType, details) {
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_logs'), { action: actionType, details: details, user: sessionUser, time: new Date().toLocaleTimeString('bn-BD'), date: new Date().toLocaleDateString('bn-BD'), timestamp: Date.now() }); } catch(e) {}
        }
        
        window.deleteItem = async function(id) {
            if(confirm("রিসাইকেল বিনে পাঠাতে চান?")) {
                try { const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'noksha_transactions_live', id); const docSnap = await getDoc(docRef); if (docSnap.exists()) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_trash'), { ...docSnap.data(), deletedBy: sessionUser, deletedAt: Date.now() }); await deleteDoc(docRef); logAction('TRASH', `${docSnap.data().amount} টাকা বিনে পাঠানো হয়েছে`); } } catch(e) { alert("ব্যর্থ!"); }
            }
        };
        window.openTrash = function() { document.getElementById('trashModal').style.display = 'flex'; const list = document.getElementById('trashList'); list.innerHTML = '<p class="text-center text-slate-400 mt-4">লোড হচ্ছে...</p>'; const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_trash')); onSnapshot(q, (snapshot) => { const items = snapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.deletedAt - a.deletedAt); list.innerHTML = items.length === 0 ? '<p class="text-center text-slate-400 mt-10">খালি</p>' : ''; items.forEach(item => { list.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-700"><div><p class="font-bold text-slate-700 dark:text-slate-200">${item.note} (${item.amount}৳)</p><p class="text-xs text-slate-400">${new Date(item.deletedAt).toLocaleDateString()}</p></div><div class="flex gap-2"><button onclick="restoreItem('${item.id}')" class="text-emerald-500 font-bold text-xs">ফেরত</button><button onclick="permanentDelete('${item.id}')" class="text-red-500 font-bold text-xs">মুছুন</button></div></div>`; }); }); }
        window.restoreItem = async function(id) { try { const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'noksha_trash', id); const docSnap = await getDoc(docRef); if(docSnap.exists()) { const { deletedBy, deletedAt, ...org } = docSnap.data(); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_transactions_live'), org); await deleteDoc(docRef); logAction('RESTORE', `রিস্টোর: ${org.amount}`); } } catch(e) { alert("ব্যর্থ!"); } }
        window.permanentDelete = async function(id) { if(confirm("স্থায়ীভাবে মুছবেন?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'noksha_trash', id)); } }
        
        window.openServiceList = () => { renderServiceList(); document.getElementById('serviceListModal').style.display = 'flex'; }
        function renderServiceList() { const c = document.getElementById('serviceListContainer'); c.innerHTML = ''; services.forEach(s => { c.innerHTML += `<div class="flex justify-between p-3 border-b dark:border-slate-700"><div onclick="selectService('${s.name}')" class="flex-1 cursor-pointer font-bold text-slate-700 dark:text-slate-200">${s.name} <span class="text-xs font-normal text-slate-400">খরচ: ${s.cost}</span></div><button onclick="deleteService('${s.id}')"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button></div>`; }); lucide.createIcons(); }
        window.selectService = (n) => { document.getElementById('noteInput').value = n; document.getElementById('serviceListModal').style.display = 'none'; }
        window.deleteService = async (id) => { if(confirm("সার্ভিসটি মুছবেন?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'noksha_services', id)); }

        window.openHistory = () => { document.getElementById('historyModal').style.display = 'flex'; const l = document.getElementById('logList'); l.innerHTML = 'লোড হচ্ছে...'; onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'noksha_logs')), (s) => { const logs = s.docs.map(d => d.data()).sort((a,b) => b.timestamp - a.timestamp); l.innerHTML = ''; logs.forEach(lg => { l.innerHTML += `<div class="p-3 border-b dark:border-slate-700"><p class="font-bold text-slate-700 dark:text-slate-200">${lg.user} <span class="font-normal text-xs">${lg.action}</span></p><p class="text-xs text-slate-500">${lg.details} | ${lg.time}</p></div>`; }); }); }
        
        // --- FIXED FACTORY RESET ---
        window.initiateFactoryReset = async function() {
            const confirmCode = prompt("সতর্কতা: এটি সব ডাটা মুছে ফেলবে! নিশ্চিত হলে লিখুন: DELETE");
            if(confirmCode === "DELETE") {
                document.getElementById('loaderText').innerText = "মুছে ফেলা হচ্ছে...";
                document.getElementById('loader').classList.remove('hidden-loader');
                
                const collections = ['noksha_services', 'noksha_transactions_live', 'noksha_logs', 'noksha_trash'];
                let totalDeleted = 0;

                try {
                    for(const colName of collections) {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', colName));
                        const snapshot = await getDocs(q);
                        
                        // Chunking to avoid 500 limit
                        const chunkSize = 400;
                        const docs = snapshot.docs;
                        
                        for (let i = 0; i < docs.length; i += chunkSize) {
                            const batch = writeBatch(db);
                            const chunk = docs.slice(i, i + chunkSize);
                            chunk.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();
                            totalDeleted += chunk.length;
                        }
                    }
                    alert("রিসেট সম্পন্ন! অ্যাপ নতুন করে চালু হচ্ছে...");
                    location.reload();
                } catch(e) { 
                    console.error(e);
                    alert("সমস্যা হয়েছে! কনসোল চেক করুন।");
                    location.reload();
                }
            }
        }
        
        window.setType = (t) => { currentType = t; const i = t==='income'; document.getElementById('btnIncome').className = `flex-1 py-2 text-sm font-bold rounded-md flex items-center justify-center gap-2 shadow-sm ${i?'bg-white dark:bg-slate-600 text-emerald-600 dark:text-emerald-400':'text-slate-500 dark:text-slate-400'}`; document.getElementById('btnWithdraw').className = `flex-1 py-2 text-sm font-bold rounded-md flex items-center justify-center gap-2 shadow-sm ${!i?'bg-white dark:bg-slate-600 text-red-600 dark:text-red-400':'text-slate-500 dark:text-slate-400'}`; document.getElementById('submitBtn').className = `w-full text-white font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2 ${i?'bg-emerald-600 hover:bg-emerald-700':'bg-red-600 hover:bg-red-700'}`; document.getElementById('submitBtn').innerHTML = i ? `<i data-lucide="plus" class="w-5 h-5"></i> সেভ করুন` : `<i data-lucide="download" class="w-5 h-5"></i> পেমেন্ট সেভ করুন`; lucide.createIcons(); }
        window.openSettings = () => document.getElementById('settingsModal').style.display = 'flex';
        window.closeSettings = () => document.getElementById('settingsModal').style.display = 'none';
        window.saveConfig = () => { let v=document.getElementById('configInput').value.trim(); if(v.indexOf('=')>0)v=v.substring(v.indexOf('=')+1).trim(); if(v.endsWith(';'))v=v.slice(0,-1).trim(); try{ const p=new Function("return "+v)(); localStorage.setItem('noksha_firebase_config', JSON.stringify(p)); location.reload(); }catch(e){alert("কোড ভুল");} };

        document.getElementById('transactionForm').addEventListener('submit', saveTransaction);
        lucide.createIcons();
    </script>
</body>
</html>